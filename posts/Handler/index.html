<!DOCTYPE html><html lang="en-US" mode="dark" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="Handler分析" /><meta name="author" content="kky" /><meta property="og:locale" content="en_US" /><meta name="description" content="1. Handler相关类总结 Handler ：用于发送和接收消息,是最外层的入口 Message：消息实体,实现了Parcelable接口,内部实现了单链表 Looper ：用于轮询消息队列，一个线程只有一个Looper MessageQueue：消息队列，用于存储消息和管理消息 ThreadLocal : 提供线程本地变量的存储" /><meta property="og:description" content="1. Handler相关类总结 Handler ：用于发送和接收消息,是最外层的入口 Message：消息实体,实现了Parcelable接口,内部实现了单链表 Looper ：用于轮询消息队列，一个线程只有一个Looper MessageQueue：消息队列，用于存储消息和管理消息 ThreadLocal : 提供线程本地变量的存储" /><link rel="canonical" href="https://kkyflying.github.io/posts/Handler/" /><meta property="og:url" content="https://kkyflying.github.io/posts/Handler/" /><meta property="og:site_name" content="kky" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-19T12:29:31+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Handler分析" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@kky" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"kky"},"dateModified":"2022-06-19T12:29:31+08:00","datePublished":"2022-06-19T12:29:31+08:00","description":"1. Handler相关类总结 Handler ：用于发送和接收消息,是最外层的入口 Message：消息实体,实现了Parcelable接口,内部实现了单链表 Looper ：用于轮询消息队列，一个线程只有一个Looper MessageQueue：消息队列，用于存储消息和管理消息 ThreadLocal : 提供线程本地变量的存储","headline":"Handler分析","mainEntityOfPage":{"@type":"WebPage","@id":"https://kkyflying.github.io/posts/Handler/"},"url":"https://kkyflying.github.io/posts/Handler/"}</script><title>Handler分析 | kky</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/favicons/icon.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">kky</a></div><div class="site-subtitle font-italic">芜湖，起飞～</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/kkyflying" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['kkyflying','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>Handler分析</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Handler分析</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jun 19, 2022, 12:29 PM +0800" > Jun 19, 2022 <i class="unloaded">2022-06-19T12:29:31+08:00</i> </span> by <span class="author"> kky </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2618 words">14 min</span></div></div><div class="post-content"><h2 id="1-handler相关类总结">1. Handler相关类总结</h2><ol><li>Handler ：用于发送和接收消息,是最外层的入口<li>Message：消息实体,实现了Parcelable接口,内部实现了单链表<li><a href="https://kkyflying.github.io/posts/Loop/">Looper</a> ：用于轮询消息队列，一个线程只有一个Looper<li><a href="https://kkyflying.github.io/posts/MessageQueue/">MessageQueue</a>：消息队列，用于存储消息和管理消息<li><a href="https://kkyflying.github.io/posts/ThreadLocal/">ThreadLocal</a> : 提供线程本地变量的存储</ol><p>在把上述的5个类都分析一遍后,可以发现重点逻辑都在MessageQueue,Looper,ThreadLocal则是实现功能的基础,Handler仅仅只是一个最外层的入口而已,并没有太多的重要的逻辑</p><h2 id="2-handler构造方法">2. Handler构造方法</h2><pre><code class="language-mermaid">flowchart TB
    A("Handler()")
    B("Handler(boolean async)")
    C("Handler(Callback callback)")
    D("Handler(Callback callback, boolean async)")
    E("Handler(Looper looper)")
    F("Handler(Looper looper,Callback callback)")
    G("Handler(Looper looper,Callback callback, boolean async)")
    A --&gt; D
    B --&gt; D
    C --&gt; D
    E --&gt; G
    F --&gt; G
</code></pre><p>虽然handler的构造方法很多,但是经过整理发现,真正调用到的就仅有两个而已</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">Handler</span><span class="o">(</span><span class="nd">@Nullable</span> <span class="nc">Callback</span> <span class="n">callback</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">async</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="no">FIND_POTENTIAL_LEAKS</span><span class="o">)</span> <span class="o">{</span>	
        <span class="kd">final</span> <span class="nc">Class</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="nc">Handler</span><span class="o">&gt;</span> <span class="n">klass</span> <span class="o">=</span> <span class="n">getClass</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">((</span><span class="n">klass</span><span class="o">.</span><span class="na">isAnonymousClass</span><span class="o">()</span> <span class="o">||</span> <span class="n">klass</span><span class="o">.</span><span class="na">isMemberClass</span><span class="o">()</span> <span class="o">||</span> <span class="n">klass</span><span class="o">.</span><span class="na">isLocalClass</span><span class="o">())</span> <span class="o">&amp;&amp;</span>
                    <span class="o">(</span><span class="n">klass</span><span class="o">.</span><span class="na">getModifiers</span><span class="o">()</span> <span class="o">&amp;</span> <span class="nc">Modifier</span><span class="o">.</span><span class="na">STATIC</span><span class="o">)</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
          	<span class="nc">Log</span><span class="o">.</span><span class="na">w</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"The following Handler class should be static or leaks might occur: "</span> <span class="o">+</span>
                    <span class="n">klass</span><span class="o">.</span><span class="na">getCanonicalName</span><span class="o">());</span>
         <span class="o">}</span>
     <span class="o">}</span>

	<span class="n">mLooper</span> <span class="o">=</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">();</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">mLooper</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span>
                <span class="s">"Can't create handler inside thread "</span> <span class="o">+</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">()</span>
                        <span class="o">+</span> <span class="s">" that has not called Looper.prepare()"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="n">mQueue</span> <span class="o">=</span> <span class="n">mLooper</span><span class="o">.</span><span class="na">mQueue</span><span class="o">;</span>
    <span class="n">mCallback</span> <span class="o">=</span> <span class="n">callback</span><span class="o">;</span>
    <span class="n">mAsynchronous</span> <span class="o">=</span> <span class="n">async</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><p>该构造中因为没有传入Looper，所以要从Looper中的ThreadLocal静态常量中获取获取当前线程的Looper（ThreadLocal中的ThreadLocalMap保存着Looper），如果当前线程没有Looper，或者说当前线程的Looper没有prepare，则直接抛出异常。</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="nf">Handler</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Looper</span> <span class="n">looper</span><span class="o">,</span> <span class="nd">@Nullable</span> <span class="nc">Callback</span> <span class="n">callback</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">async</span><span class="o">)</span> <span class="o">{</span>
	<span class="n">mLooper</span> <span class="o">=</span> <span class="n">looper</span><span class="o">;</span>
	<span class="n">mQueue</span> <span class="o">=</span> <span class="n">looper</span><span class="o">.</span><span class="na">mQueue</span><span class="o">;</span>
	<span class="n">mCallback</span> <span class="o">=</span> <span class="n">callback</span><span class="o">;</span>
	<span class="n">mAsynchronous</span> <span class="o">=</span> <span class="n">async</span><span class="o">;</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="3-handler发送任务的方法">3. Handler发送任务的方法</h2><pre><code class="language-mermaid">graph LR
    subgraph send
    e1("enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis)")
    s1("sendEmptyMessage(int what)")
    s2("sendEmptyMessageAtTime(int what, long uptimeMillis)")
    s3("sendEmptyMessageDelayed(int what, long delayMillis)")
    s4("sendMessage(Message msg)")
    s5("sendMessageAtFrontOfQueue(Message msg)")
    s6("sendMessageAtTime(Message msg, long uptimeMillis)")
    s7("sendMessageDelayed(Message msg, long delayMillis)")
    s1 --&gt; s3 --&gt; s7 --&gt; s6 --&gt; e1
    s2 --&gt; s6	
    s4 --&gt; s7
    s5 --&gt; e1
    end

    subgraph post
    p1("post(Runnable r)")
    p5("postDelayed(Runnable r, long delayMillis)")
    p2("postAtFrontOfQueue(Runnable r)")
    p3("postAtTime(Runnable r, long uptimeMillis)")
    p4("postAtTime(Runnable r, Object token, long uptimeMillis)")
    p6("postDelayed(Runnable r, Object token, long delayMillis)")
    gp1("getPostMessage(Runnable r)")
    gp2("getPostMessage(Runnable r, Object token)")
    p1 --&gt; gp1 --&gt; s7
    p5 --&gt; gp1	
    p2 --&gt; gp1 --&gt; s5
    p3 --&gt; gp1 --&gt; s6
    p6 --&gt; gp2 --&gt; s7
    p4 --&gt; gp2 --&gt; s6
    end
	
    subgraph obtain
    o1("obtainMessage()")
    o2("obtainMessage(int what)")
    o3("obtainMessage(int what, int arg1, int arg2)")
    o4("obtainMessage(int what, int arg1, int arg2, Object obj)")
    o5("Message obtainMessage(int what, Object obj)")
    msg("sendToTarget()")
    o1 --&gt; msg --&gt; s4
    o2 --&gt; msg
    o3 --&gt; msg
    o4 --&gt; msg
    o5 --&gt; msg
    end
  
</code></pre><p>通过上述流程图的总结,可以把发送任务的方法分为send;post;obtain三类方法</p><ol><li>obtain类方法其实就是先构造Message,并通过sendMessage发送出去<li>post类方法先通过getPostMessage方法把Runnable构建到Message里,再通过send类方法发送任务<li>send类方法在调用的过程中也是构造Message,最后调用enqueueMessage,把msg加入MessageQueue</ol><p>所以其实可以忽略这些发送方法,分析enqueueMessage即可,而在这个方法里实际上调用了<a href="https://kkyflying.github.io/posts/MessageQueue/#3-%E6%8F%92%E5%85%A5%E6%93%8D%E4%BD%9C-enqueuemessage">MessageQueue中的enqueueMessage</a></p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">enqueueMessage</span><span class="o">(</span><span class="nc">MessageQueue</span> <span class="n">queue</span><span class="o">,</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">long</span> <span class="n">uptimeMillis</span><span class="o">)</span> <span class="o">{</span>
    <span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">mAsynchronous</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="na">enqueueMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">uptimeMillis</span><span class="o">);</span>
    <span class="o">}</span>
</pre></table></code></div></div><h2 id="4-handler回调分析">4. Handler回调分析</h2><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
</pre><td class="rouge-code"><pre> <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Callback</span> <span class="o">{</span>
        <span class="cm">/**
         * @param msg A {@link android.os.Message Message} object
         * @return True if no further handling is desired
         */</span>
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * Subclasses must implement this to receive messages.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
    <span class="o">}</span>
    
    <span class="cm">/**
     * Handle system messages here.
     */</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispatchMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">callback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleCallback</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mCallback</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><ol><li>Callback接口是在Handler构造方法时传入的<li><code class="language-plaintext highlighter-rouge">handleMessage(Message msg)</code>就是使用handler时重写处理msg的方法,在这里添加上需要处理的任务<li><code class="language-plaintext highlighter-rouge">dispatchMessage(Message msg)</code>方法则是在<a href="https://kkyflying.github.io/posts/Loop/#5-looperloop">Looper.loop()</a>被调用<li>在<code class="language-plaintext highlighter-rouge">dispatchMessage(Message msg)</code>逻辑里,先判断msg里的callback是否为空,不为空则调用callback,这里的callback实际类型为Runnable,就是在post类方法里传入的;而mCallback则是在handler的构造方法里传入,如果传入了mCallback,handleMessage(Message msg)则不会调用</ol><h2 id="5-runwithscissors">5. runWithScissors</h2><p>Handler中有一个静态内部类BlockingRunnable</p><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">runWithScissors</span><span class="o">()(</span><span class="kd">final</span> <span class="nc">Runnable</span> <span class="n">r</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
    <span class="c1">//注释1</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">r</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"runnable must not be null"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"timeout must be non-negative"</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="c1">//注释3</span>
    <span class="k">if</span> <span class="o">(</span><span class="nc">Looper</span><span class="o">.</span><span class="na">myLooper</span><span class="o">()</span> <span class="o">==</span> <span class="n">mLooper</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">r</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
        <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
    <span class="o">}</span>
    <span class="nc">BlockingRunnable</span> <span class="n">br</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">BlockingRunnable</span><span class="o">(</span><span class="n">r</span><span class="o">);</span>
    <span class="k">return</span> <span class="n">br</span><span class="o">.</span><span class="na">postAndWait</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">timeout</span><span class="o">);</span>
    <span class="o">}</span>

<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">BlockingRunnable</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="kd">private</span> <span class="kd">final</span> <span class="nc">Runnable</span> <span class="n">mTask</span><span class="o">;</span>
        <span class="kd">private</span> <span class="kt">boolean</span> <span class="n">mDone</span><span class="o">;</span>

        <span class="kd">public</span> <span class="nf">BlockingRunnable</span><span class="o">(</span><span class="nc">Runnable</span> <span class="n">task</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">mTask</span> <span class="o">=</span> <span class="n">task</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="c1">//注释3</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="n">mTask</span><span class="o">.</span><span class="na">run</span><span class="o">();</span>
            <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">mDone</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                    <span class="n">notifyAll</span><span class="o">();</span>
                <span class="o">}</span>
            <span class="o">}</span>
        <span class="o">}</span>
        
        <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">postAndWait</span><span class="o">(</span><span class="nc">Handler</span> <span class="n">handler</span><span class="o">,</span> <span class="kt">long</span> <span class="n">timeout</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">handler</span><span class="o">.</span><span class="na">post</span><span class="o">(</span><span class="k">this</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="kt">long</span> <span class="n">expirationTime</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">timeout</span><span class="o">;</span>
                    <span class="k">while</span> <span class="o">(!</span><span class="n">mDone</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kt">long</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">expirationTime</span> <span class="o">-</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">delay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span> <span class="c1">// timeout</span>
                        <span class="o">}</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">wait</span><span class="o">(</span><span class="n">delay</span><span class="o">);</span><span class="c1">//限时等待</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="k">while</span> <span class="o">(!</span><span class="n">mDone</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">try</span> <span class="o">{</span>
                            <span class="n">wait</span><span class="o">();</span> <span class="c1">//无限期等待</span>
                        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">InterruptedException</span> <span class="n">ex</span><span class="o">)</span> <span class="o">{</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>
</pre></table></code></div></div><h3 id="41-runwithscissors作用">4.1 runWithScissors作用</h3><p>此方法可以实现,在<strong>子线程</strong>中通过Handler向<strong>主线程</strong>中发送一个任务,并要等<strong>主线程</strong>处理完成此任务后,<strong>子线程</strong>才能继续执行任务</p><h3 id="42-runwithscissors分析">4.2 runWithScissors分析</h3><ol><li>注释1: 先判断传入的runnable和timeout的校验<li>注释2: Looper.myLooper()获得当前线程下的looper,和调用的handler里的looper对比是否相同,就可以判断当前线程是否和Handler处理的线程是否一致,如果一致则直接运行run();<li>线程不一致的情况下,则把runnable和timeout传入BlockingRunnable中</ol><h3 id="43-blockingrunnable分析">4.3 BlockingRunnable分析</h3><ol><li>注释3: run中执行了从runWithScissors传递过来的runnable,并在执行完成后,设置mDone标志位为true,notifyAll()并唤醒线程<li>postAndWait方法里,通过post把任务发出去,并设置timeout,在这个方法中,只有两种返回false的情况: 3.1 handler的post失败,可能是Looper挂掉了 3.2 等待timeout超时,任务还没结束<li>子线程在调用runWithScissors后则是在postAndWait中阻塞,等待任务的完成,根据返回值来判断任务是否完成</ol><h3 id="44-runwithscissors的隐患">4.4 runWithScissors()的隐患</h3><p>看似一个很不错的方法,但此方法仍是被@hide标注,说明并不想让应用层app开发者所调用,那么其中应该还是有一些问题的</p><h4 id="441-如果timeout超时了">4.4.1 如果timeout超时了</h4><p>假设设置timeout为2秒,在2秒过后,那么等待超时返回false,子线程唤醒会后根据返回值false来继续完成任务,可是此时,之前通过handler发送的任务依旧还在MessageQueue里,并没有被移除,等待Looper取出,最后还是会在主线程中调用,那么何时完成就变得不可控了,会发生什么事情就变得不可预估了</p><h4 id="442-出现死锁的可能">4.4.2 出现死锁的可能</h4><ol><li>假设子线程中持有别的锁,这个时候子线程若是等不到唤醒,那么就有可能造成了死锁<li>一般来说通过handler发送任务加入到MessageQueue里,最后都会被Looper取出执行,但是如果调用了quit()退出时候,会清理掉所有任务,那么这个子线程则永远得不到唤醒了<li>因此在使用runWithScissors的时候,要么保证调用的handler所在在线程不退出,Looper不退出,例如发送主线程就不会退出,要么退出要调用quitSafely()<li>因为quit()退出会清除掉所有的在MessageQueue里的任务,而quitSafely()只会清除在(p.when &gt; now)当前时间点之后的消息</ol><p>在java中，非静态内部类 &amp; 匿名内部类 都默认持有外部类的引用</p><h2 id="5-异步消息和同步屏障">5. 异步消息和同步屏障</h2><ol><li>其实单纯的发一个异步消息其实没啥意义,一样按照同步消息一样的规则进队,只要加入同步屏障后,才能优先执行异步消息</ol><h2 id="6-handler内存泄漏">6. Handler内存泄漏</h2><h3 id="61-原因分析">6.1 原因分析</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>
    
    <span class="c1">//匿名内部类</span>
    <span class="kd">private</span> <span class="nc">Handler</span> <span class="n">handler1</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Handler</span><span class="o">(){</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">){</span>
                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="kd">super</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">};</span>
    
    <span class="c1">//非静态内部类</span>
    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span><span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">){</span>
                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="kd">super</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
                    <span class="k">break</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
<span class="o">}</span>    
</pre></table></code></div></div><ol><li>主线程Looper的生命周期和整个应用进程一致,只有当应用进程退出的时候,主线程Looper才会退出,而Looper中又持有着MessageQueue<li>在以上两种方式来实现handler下,因为匿名内部类和非静态内部类都默认持有外部类的引用,那handler在使用上述的两种方式的情况下,就会持有了外部的MainActivity了<li>当MainActivity退出的时候,如果主线程下的MessageQueue还有未处理或者正在处理的msg,那msg就会持有handler,而handler又持有着MainActivity</ol><pre><code class="language-mermaid">flowchart TB
    subgraph Handler内部持有关系
        A("Handler实例&lt;br&gt;(匿名内部类或是非静态内部类)")
        B("主线程Looper")
        C("主线程MessageQueue")
        D("msg.target")
        A --引用--&gt; B
        B --持有--&gt; C
        D --持有--&gt; A
        C --保存--&gt; D
    end 
    
    A1("MainActivity实例&lt;br&gt;(外部类)")
    B2("准备释放MainActivity实例")
    C2("内存泄漏")
    A --持有--&gt; A1
    A1 --被持续持有下--&gt; B2
    B2 --无法释放--&gt;C2
</code></pre><h3 id="62-解决方案">6.2 解决方案</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MainActivity</span> <span class="kd">extends</span> <span class="nc">AppCompatActivity</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span>  <span class="kd">class</span> <span class="nc">MyHandler</span> <span class="kd">extends</span> <span class="nc">Handler</span><span class="o">{</span>
        <span class="kd">private</span> <span class="nc">WeakReference</span><span class="o">&lt;</span><span class="nc">Activity</span><span class="o">&gt;</span> <span class="n">reference</span><span class="o">;</span>
        
        <span class="kd">public</span> <span class="nf">MyHandler</span><span class="o">(</span><span class="nc">Activity</span> <span class="n">reference</span><span class="o">){</span>
            <span class="kd">super</span><span class="o">(</span><span class="nc">Looper</span><span class="o">.</span><span class="na">getMainLooper</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">reference</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">WeakReference</span><span class="o">&lt;&gt;(</span><span class="n">reference</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">handleMessage</span><span class="o">(</span><span class="nd">@NonNull</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">switch</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">what</span><span class="o">){</span>
                <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                    <span class="k">break</span><span class="o">;</span>
                <span class="k">default</span><span class="o">:</span>
                    <span class="kd">super</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
    
    <span class="kd">private</span> <span class="nc">MyHandler</span> <span class="n">myHandler</span><span class="o">;</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onCreate</span><span class="o">(</span><span class="nc">Bundle</span> <span class="n">savedInstanceState</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onCreate</span><span class="o">(</span><span class="n">savedInstanceState</span><span class="o">);</span>
        <span class="n">setContentView</span><span class="o">(</span><span class="no">R</span><span class="o">.</span><span class="na">layout</span><span class="o">.</span><span class="na">activity_main</span><span class="o">);</span>
        <span class="n">myHandler</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MyHandler</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
    <span class="o">}</span>
    
    <span class="nd">@Override</span>
    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">onDestroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">.</span><span class="na">onDestroy</span><span class="o">();</span>
        <span class="n">myHandler</span><span class="o">.</span><span class="na">removeCallbacksAndMessages</span><span class="o">(</span><span class="kc">null</span><span class="o">);</span>
    <span class="o">}</span>
    
</pre></table></code></div></div><ol><li>这静态内部类不持有外部类,使得handler不再持有MainActivity<li>使用WeakReference弱引用来持有外部类,保证外部类可以被回收<li>在MainActivity的生命周期结束onDestroy下清空handler中的msg</ol></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/android/'>Android</a>, <a href='/categories/handler/'>Handler</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/android/" class="post-tag no-text-decoration" >Android</a> <a href="/tags/handler/" class="post-tag no-text-decoration" >Handler</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/ThreadLocal/">ThreadLocal分析</a><li><a href="/posts/Android_Zxing/">关于Android Zxing 3.3.0 的填坑</a><li><a href="/posts/Server_Config_Tomcat_Nginx/">服务器应用的配置小记录笔记</a><li><a href="/posts/Server_Config_Nginx_Gunicorn_django/">Nginx + Gunicorn + Django 部署</a><li><a href="/posts/Android_Framework_Start_Animation/">Android系统-修改开机动画</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/handler/">Handler</a> <a class="post-tag" href="/tags/framework/">Framework</a> <a class="post-tag" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a> <a class="post-tag" href="/tags/messagequeue/">MessageQueue</a> <a class="post-tag" href="/tags/c-c/">C/C++</a> <a class="post-tag" href="/tags/nginx/">Nginx</a> <a class="post-tag" href="/tags/androidautosize/">AndroidAutoSize</a> <a class="post-tag" href="/tags/django/">Django</a> <a class="post-tag" href="/tags/gunicorn/">Gunicorn</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/Loop/"><div class="card-body"> <span class="timeago small" > May 8, 2022 <i class="unloaded">2022-05-08T19:44:52+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Looper分析</h3><div class="text-muted small"><p> 1. Looper的简单介绍 /** * Class used to run a message loop for a thread. Threads by default do * not have a message loop associated with them; to create one, call * {@link #prepare} in the thread...</p></div></div></a></div><div class="card"> <a href="/posts/Handler-native/"><div class="card-body"> <span class="timeago small" > Sep 14, 2023 <i class="unloaded">2023-09-14T23:30:49+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MessageQueue的Native方法分析</h3><div class="text-muted small"><p> 前置 Handler并没有直接调用native，而是通过MessageQueue 相关的主要native代码 1 2 frameworks/base/core/jni/android_os_MessageQueue.cpp system/core/libutils/Looper.cpp MessageQueue.java中native方法的分析 路径 frameworks/base/c...</p></div></div></a></div><div class="card"> <a href="/posts/ThreadLocal/"><div class="card-body"> <span class="timeago small" > Mar 24, 2021 <i class="unloaded">2021-03-24T23:26:31+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>ThreadLocal分析</h3><div class="text-muted small"><p> 1. ThreadLocal的简单介绍 /** * This class provides thread-local variables. These variables differ from * their normal counterparts in that each thread that accesses one (via its * {@code get} or {@...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/Loop/" class="btn btn-outline-primary" prompt="Older"><p>Looper分析</p></a> <a href="/posts/dp-01-package/" class="btn btn-outline-primary" prompt="Newer"><p>01背包</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2025 <a href="https://github.com/kkyflying">kky</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/android/">Android</a> <a class="post-tag" href="/tags/handler/">Handler</a> <a class="post-tag" href="/tags/framework/">Framework</a> <a class="post-tag" href="/tags/%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92/">动态规划</a> <a class="post-tag" href="/tags/messagequeue/">MessageQueue</a> <a class="post-tag" href="/tags/c-c/">C/C++</a> <a class="post-tag" href="/tags/nginx/">Nginx</a> <a class="post-tag" href="/tags/androidautosize/">AndroidAutoSize</a> <a class="post-tag" href="/tags/django/">Django</a> <a class="post-tag" href="/tags/gunicorn/">Gunicorn</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><script src="https://cdn.jsdelivr.net/npm/mermaid@8/dist/mermaid.min.js"></script> <script> $(function() { let initTheme = "default"; if ($("html[mode=dark]").length > 0 || ($("html[mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches ) ) { initTheme = "dark"; } let mermaidConf = { theme: initTheme /* <default|dark|forest|neutral> */ }; /* Markdown converts to HTML */ $("pre").has("code.language-mermaid").each(function() { let svgCode = $(this).children().html(); $(this).addClass("unloaded"); $(this).after(`<div class=\"mermaid\">${svgCode}</div>`); }); mermaid.initialize(mermaidConf); }); </script><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://kkyflying.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
